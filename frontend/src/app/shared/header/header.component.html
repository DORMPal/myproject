<p-toast position="top-center"></p-toast>
<header class="app-header shadow-1 px-3 py-2 flex align-items-center justify-content-between">
  <div class="brand flex align-items-center gap-2">
    <img class="logo" src="/assets/logo/logoProject.svg" alt="PantryChef logo" />
    <span class="brand-name text-900">PantryChef</span>
  </div>

  <div class="desktop-menu hidden md:flex align-items-center gap-4 flex-1 justify-content-end">
    <nav class="nav flex align-items-center gap-4">
      <a class="nav-link" [class.active]="active === 'recipes'" routerLink="/page/recipes">
        <span class="icon">
          <img src="/assets/header/recipeLogo.svg" alt="Recipes" />
        </span>
        <span class="label">สูตรอาหาร</span>
      </a>

      <a class="nav-link" [class.active]="active === 'ingredients'" routerLink="/page/ingredient">
        <span class="icon">
          <img src="/assets/header/ingredientLogo.svg" alt="Ingredients" />
        </span>
        <span class="label">วัตถุดิบของฉัน</span>
      </a>
    </nav>

    <div class="user flex align-items-center gap-3 border-left-1 border-gray-300 pl-3">
      <p-button
        [icon]="isListening ? 'pi pi-stop' : 'pi pi-microphone'"
        [rounded]="true"
        [text]="true"
        [severity]="isListening ? 'danger' : 'secondary'"
        (click)="toggleSpeech()"
        pTooltip="สั่งงานด้วยเสียง"
        tooltipPosition="bottom"
      >
      </p-button>
      <span class="username text-800">{{ name?.name }}</span>

      <p-overlaybadge
        value="{{ nums_notifications }}"
        severity="danger"
        [style]="{ cursor: 'pointer' }"
        (click)="toggle_notifications = !toggle_notifications"
      >
        <i class="pi pi-bell" style="font-size: 1.5rem"></i>

        <div
          class="absolute border-1 overflow-y-auto z-5 right-0 shadow-2 border-round-md"
          style="
            width: 300px;
            max-height: 300px;
            background-color: #fff;
            top: 100%;
            margin-top: 10px;
          "
          *ngIf="toggle_notifications"
        >
          <div *ngIf="notifications.length === 0" class="p-3 text-center">
            <p class="m-0">No notifications</p>
          </div>
          <div
            *ngFor="let notification of notifications"
            class="p-3 border-bottom-1 cursor-pointer hover:bg-gray-100 text-left"
            [class.bg-gray-50]="!notification.read_yet"
            (click)="markAsRead(notification.id)"
          >
            <div class="flex flex-column gap-2">
              <span class="font-semibold text-sm">{{ notification.ingredient_name }}</span>
              <p class="m-0 text-xs text-500">{{ notification.created_at | date : 'short' }}</p>
            </div>
          </div>
        </div>
      </p-overlaybadge>

      <button class="logout" type="button" (click)="logout()">
        <span class="logout-icon"><i class="pi pi-sign-out"></i></span>
        <span class="logout-text">Logout</span>
      </button>
    </div>
  </div>

  <div class="mobile-menu md:hidden">
    <p-button icon="pi pi-bars" [text]="true" severity="secondary" (click)="sidebarVisible = true">
    </p-button>
  </div>
</header>

<p-drawer [(visible)]="sidebarVisible" position="right" [style]="{ width: '300px' }">
  <ng-template pTemplate="header">
    <div class="flex align-items-center gap-2">
      <img src="/assets/logo/logoProject.svg" alt="logo" style="width: 30px" />
      <span class="font-bold text-xl">Menu</span>
    </div>
  </ng-template>

  <div class="flex flex-column h-full">
    <div class="flex align-items-center gap-3 mb-4 p-3 bg-gray-50 border-round text-black-alpha-90">
      <i class="pi pi-user border-circle bg-gray-200 p-2"></i>
      <div class="flex flex-column">
        <span class="font-bold">{{ name?.name || 'Guest' }}</span>
      </div>
    </div>

    <div class="flex flex-column gap-2">
      <a
        routerLink="/page/recipes"
        class="flex align-items-center gap-3 p-3 border-round text-black-alpha-90 no-underline hover:bg-gray-100 transition-duration-150"
        [class.bg-blue-50]="active === 'recipes'"
        [class.text-black-alpha-90]="active === 'recipes'"
        [class.text-white]="active !== 'recipes'"
        (click)="closeSidebar()"
      >
        <i class="pi pi-book text-xl"></i> <span class="font-medium">สูตรอาหาร</span>
      </a>

      <a
        routerLink="/page/ingredient"
        class="flex align-items-center gap-3 p-3 border-round text-black-alpha-90 no-underline hover:bg-gray-100 transition-duration-150"
        [class.bg-blue-50]="active === 'ingredients'"
        [class.text-black-alpha-90]="active === 'ingredients'"
        [class.text-white]="active !== 'ingredients'"
        (click)="closeSidebar()"
      >
        <i class="pi pi-box text-xl"></i>
        <span class="font-medium">วัตถุดิบของฉัน</span>
      </a>
    </div>

    <hr class="w-full border-gray-200 my-3" />

    <div class="flex flex-column gap-2 flex-1 overflow-y-auto" style="min-height: 150px">
      <div class="flex justify-content-between align-items-center mb-2 px-1">
        <span class="font-semibold text-gray-500 text-sm">NOTIFICATIONS</span>
        <p-badge
          [value]="nums_notifications"
          severity="danger"
          *ngIf="nums_notifications > 0"
        ></p-badge>
      </div>

      <div *ngIf="notifications.length === 0" class="text-center text-500 text-sm py-4">
        No new notifications
      </div>

      <div
        *ngFor="let notification of notifications"
        class="p-3 border-round cursor-pointer hover:bg-gray-100 border-1 border-transparent mb-1"
        [class.bg-blue-50]="!notification.read_yet"
        (click)="markAsRead(notification.id)"
      >
        <div class="flex flex-column gap-1">
          <span class="font-medium text-sm">{{ notification.ingredient_name }}</span>
          <span class="text-xs text-500"
            >Exp: {{ notification.expiration_date | date : 'dd/MM' }}</span
          >
        </div>
      </div>
    </div>
    <div class="p-3 border-top-1 border-gray-200">
      <div class="text-center mb-2 font-bold text-gray-500">Voice Command</div>

      <button
        pButton
        [label]="isListening ? 'กำลังฟัง...' : 'กดเพื่อพูด'"
        [icon]="isListening ? 'pi pi-spin pi-spinner' : 'pi pi-microphone'"
        [severity]="isListening ? 'danger' : 'primary'"
        class="w-full p-button-rounded"
        (click)="toggleSpeech()"
      ></button>

      <div
        *ngIf="voiceText"
        class="mt-2 text-center text-sm text-blue-600 bg-blue-50 p-2 border-round"
      >
        "{{ voiceText }}"
      </div>
    </div>

    <div class="mt-auto pt-3 border-top-1 border-gray-200">
      <button
        pButton
        label="Logout"
        icon="pi pi-sign-out"
        class="p-button-danger p-button-text w-full"
        (click)="logout()"
      ></button>
    </div>
  </div>
</p-drawer>
