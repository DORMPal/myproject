<app-header active="ingredients" />
<p-toast></p-toast>

<p-dialog
  header="Add Ingredient"
  [(visible)]="visible"
  [style]="{ width: '45rem', height: '300px' }"
  modal="true"
>
  <div class="flex flex-column gap-3 justify-content-between h-full">
    <div class="flex flex-column gap-3">
      <p-select
        [options]="ingredients$ | async"
        [(ngModel)]="selectedIngredient"
        optionLabel="name"
        [filter]="true"
        filterBy="name"
        [showClear]="true"
        placeholder="Select an ingredient"
        class="w-full"
        virtualScroll="true"
        virtualScrollItemSize="50"
        scrollHeight="270px"
        appendTo="body"
      ></p-select>

      <p-datepicker
        showClear="true"
        [(ngModel)]="date"
        placeholder="Expiration date (optional)"
        class="w-full"
        appendTo="body"
      ></p-datepicker>
    </div>
    <div *ngIf="errorMsg" class="p-2 border border-red-300 text-red-600 rounded">
      {{ errorMsg }}
    </div>

    <div class="flex justify-end gap-2">
      <p-button label="Cancel" severity="secondary" (click)="visible = false" />
      <p-button label="Save" [loading]="saving" (click)="onSave()" />
    </div>
  </div>
</p-dialog>

<div class="page">
  <div class="page-header">
    <div>
      <div class="title mb-3">วัตถุดิบของฉัน</div>
      <div class="subtitle">จัดการวัตถุดิบและติดตามวันหมดอายุ</div>
    </div>
    <p-button (click)="showDialog()" label="เพิ่มวัตถุดิบ" icon="pi pi-plus" styleClass="add-btn" />
  </div>

  <div class="stats grid">
    <div class="col-12 md:col-4">
      <p-card class="stat-card">
        <div class="stat-label">วัตถุดิบทั้งหมด</div>
        <div class="stat-value">{{ totalCount }}</div>
      </p-card>
    </div>
    <div class="col-12 md:col-4">
      <p-card class="stat-card">
        <div class="stat-label">กำลังจะหมดอายุ</div>
        <div class="stat-value">{{ expiringSoon }}</div>
      </p-card>
    </div>
    <div class="col-12 md:col-4">
      <p-card class="stat-card">
        <div class="stat-label">หมดอายุ</div>
        <div class="stat-value danger">{{ expired }}</div>
      </p-card>
    </div>
  </div>

  <div class="search-bar flex align-items-center gap-3">
    <i class="pi pi-search"></i>
    <input pInputText type="text" [(ngModel)]="searchTerm" placeholder="ค้นหาวัตถุดิบ..." />
  </div>

  <p-card class="table-card">
    <p-table
      [value]="filteredStocks"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 20, 50]"
      [responsiveLayout]="'scroll'"
      [loading]="loading"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>ชื่อ</th>
          <!-- <th>จำนวน</th> -->
          <th>วันหมดอายุ</th>
          <th class="action-col">Action</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-row>
        <tr>
          <td>{{ row.ingredient.name }}</td>
          <!-- <td>{{ row.quantity ?? '-' }}</td> -->
          <td>{{ row.expiration_date ?? '-' }}</td>
          <td class="actions">
            <p-button
              label="ลบ"
              size="small"
              [text]="true"
              severity="danger"
              (click)="onDelete(row)"
            />
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>
